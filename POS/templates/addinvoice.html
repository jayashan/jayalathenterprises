{% load crispy_forms_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="UTF-8" />
    <title>{{title}}</title>

    <script src="{% static '/js/myjs.js '%}" type="text/javascript"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"/>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="{% static 'js/myjs.js' %}"></script>
    <link rel="stylesheet"  href="{%  static  'css/mystyle.css'  %}">


    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.standalone.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

  </head>
  <body>
    {% include 'navibar.html' %}
    <div class="container">
      <div class="myform">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Bill Number</label>
            <input class="form-control" type="text" id="bill_number" name="bill_number">
          </div>
          <div class="form-group col-md-6">
            <label>Date</label>
            <input type="text" id="datepicker" class="form-control">
          </div>
          <div class="form-group">
            <label>Customer Name</label>
            <input class="form-control" type="text" id="customer_name" name="customer_name">
          </div>
          <div class="form-group col-md-2">
            <label>Invoice Type</label>
            <select class="form-control" id="type">
              <option>CASH</option>
              <option>PAID</option>
              <option>CREDIT</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-6">
            <h2>Invoice Details</h2>
          </div>
        </div>
        <div class="shadow-none p-3 mb-5 bg-light rounded">
          <div class="row">
            <div class="col-sm-6">
              <div class="panel panel-primary">
                <div class="panel-body">
                  <div class="form-group">
                    <label>Vehicle Number</label>
                    <input type="text" class="form-control" id="vehicle_number" />
                  </div>
                  <div class="form-group">
                    <label>Product Name</label>
                    <select class="form-control" id="product_name">
                      <option disabled="true" selected>-----------</option>
                      {% for products in products %}
                        <option>{{products.product_id}}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Price</label>
                    <input type="url" class="form-control" id="price" />
                  </div>
                </div>
                <div class="panel-footer">
                  <div class="row">
                    <div class="col-xs-12">
                      <button type="button" id="updateButton" class="btn btn-primary" onclick="productUpdate();">Add</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-6">
            <table id="productTable" class="table table-bordered table-condensed table-striped">
              <thead>
                <tr>
                  <th>Edit</th>
                  <th>Vehicle Number</th>
                  <th>Product Name</th>
                  <th>Price</th>
                  <th>Delete</th>
                </tr>
              </thead>
                <tbody  id="productTableBody">

                </tbody>
            </table>
          </div>
        </div>
        <div class="row">
          <div class="col-4">
            <label id="val">0.00</label>
          </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <button class="btn btn-block btn-success" type="submit" value="Save" id="save_all_btn">SAVE ALL</button>
            </div>
        </div>
      </div>
    </div>
    <script>

          // Next id for adding a new Product
          var nextId = 1;
          // ID of Product currently editing
          var activeId = 0;

          function productDisplay(ctl) {
            var row = $(ctl).parents("tr");
            var cols = row.children("td");

            activeId = $($(cols[0]).children("button")[0]).data("id");
            $("#vehicle_number").val($(cols[1]).text());
            $("#product_name").val($(cols[2]).text());
            $("#price").val($(cols[3]).text());
            // Change Update Button Text
            $("#updateButton").text("Update");
          }



          function productUpdate() {
            if ($("#updateButton").text() == "Update") {
              productUpdateInTable(activeId);
            }
            else {
              productAddToTable();

            }

            // Clear form fields
            formClear();

            //get total amount
            getTotal();
            // Focus to product name field
            $("#vehicle_number").focus();
          }

          // Add product to <table>
          function productAddToTable() {
            // First check if a <tbody> tag exists, add one if not
            if ($("#productTable tbody").length == 0) {
              $("#productTable").append("<tbody id='productTableBody'></tbody>");
            }

            // Append product to table
            $("#productTable tbody").append(
              productBuildTableRow(nextId));


            // Increment next ID to use
            nextId += 1;
          }

          // Update product in <table>
          function productUpdateInTable(id) {
            // Find Product in <table>
            var row = $("#productTable button[data-id='" + id + "']")
                      .parents("tr")[0];

            // Add changed product to table
            $(row).after(productBuildTableRow(id));
            // Remove original product
            $(row).remove();

            // Clear form fields
            formClear();

            // Change Update Button Text
            $("#updateButton").text("Add");
            getTotal();
          }

          // Build a <table> row of Product data
          function productBuildTableRow(id) {
            var ret =
            "<tr>" +
              "<td>" +
                "<button type='button' " +
                        "onclick='productDisplay(this);' " +
                        "class='btn btn-info' " +
                        "data-id='" + id + "'>" +
                        "Edit"+
                "</button>" +
              "</td>" +
              "<td>" + $("#vehicle_number").val() + "</td>" +
              "<td>" + $("#product_name").val() + "</td>" +
              "<td>" + $("#price").val() + "</td>" +
              "<td>" +
                "<button type='button' " +
                        "onclick='productDelete(this);' " +
                        "class='btn btn-danger' " +
                        "data-id='" + id + "'>" +
                        "Delete" +
                "</button>" +
              "</td>" +
            "</tr>"

            return ret;
          }

          // Delete product from <table>
          function productDelete(ctl) {
            $(ctl).parents("tr").remove();
            getTotal();
          }

          function onClick(event) {
            var subtotal = 0;
            $('#subtotal').val(subtotal);
          }

          // Clear form fields
          function formClear() {
            $("#vehicle_number").val("");
            $("#product_name").val("");
            $("#price").val("");
          }



          function getTotal() {

            var table = document.getElementById("productTableBody");
            let sumVal = 0;

            for(var i = 0; i < table.rows.length; i++) {
                sumVal += isNaN(table.rows[i].cells[3].innerHTML) ? 0 : parseInt(table.rows[i].cells[3].innerHTML);
            }

            document.getElementById("val").innerHTML = sumVal;
          }




          $("#save_all_btn").click(function(){

            console.log('save all');
            var bill_number=$("#bill_number").val();
            var date=$("#datepicker").val();
            var customer_name=$("#customer_name").val();
            var subtotal=$("#val").text();
            var type=$("#type").val();


            console.log(bill_number);
            console.log(date);
            console.log(customer_name);
            console.log(subtotal);
            console.log(type);


            var json_data=[];

            $("tbody tr").each(function(){
                var vehicle_number=$(this).children().eq(1).text()
                var product_name=$(this).children().eq(2).text()
                var price=$(this).children().eq(3).text()

                console.log(vehicle_number);
                console.log(product_name);
                console.log(price);


                var single_data={"vehicle_number":vehicle_number,"product_name":product_name,"price":price};
                json_data.push(single_data);
            });
                console.log(json_data);

                var string_data=JSON.stringify(json_data)

                $.ajax({
                  url:'{% url 'save_all' %}',
                  type:'POST',
                  data:{
                    data:string_data,
                    bill_number:$("#bill_number").val(),
                    bill_date:$("#datepicker").val(),
                    customer_name:$("#customer_name").val(),
                    type:$("#type").val(),
                    sub_total:$("#val").text()
                  }
                })
                .done(function(response){
                  location.reload();
                })
                .fail(function(){
                })
                .always(function(){
                })
          });


    </script>
  </body>
</html>
